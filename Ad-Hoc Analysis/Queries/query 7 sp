CREATE DEFINER=`root`@`localhost` PROCEDURE `forecast_accuracy`(fy int)
BEGIN
with cte1 as (
select *, forecast_quantity - sold_quantity as net_error, abs(forecast_quantity - sold_quantity) as abs_net_error
from fact_act_est
)
select s.customer_code, c.customer, c.market, sum(s.sold_quantity) as total_sold_qnt,
 sum(s.forecast_quantity) as total_forecast_qnt, sum(net_error) as net_error, 
 round((sum(net_error) * 100) / sum(forecast_quantity),2) as net_error_per, sum(abs_net_error) as abs_net_error, 
 round((sum(abs_net_error)* 100) / sum(forecast_quantity),2) as abs_net_error_per, 
 if ((sum(abs_net_error)* 100) / sum(forecast_quantity) > 100, 0, 
     round(100 - (sum(abs_net_error)* 100) / sum(forecast_quantity),2)) as forecast_accuracy 
from cte1 s
join dim_customer c
on s.customer_code = c.customer_code
where fiscal_year = fy
group by s.customer_code  
order by forecast_accuracy ;
END
